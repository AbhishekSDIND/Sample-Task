
ALTER TABLE UserDetail
ADD IMAGE_NAME varchar(100);
ALTER TABLE UserDetail
ADD USER_IMAGE image;


alter PROCEDURE [dbo].[SP_USERDETAIL]
(
@UserId	int	=NULL,
@FIRST_NAME	varchar(20)	=NULL,
@LAST_NAME	varchar(20)	=NULL,
@USER_NAME	varchar(20)	=NULL,
@USER_PASSWORD	varchar(20)	=NULL,
@USER_TYPE	int	=NULL,
@LOGIN_DATE DATETIME = NULL,
@MODE VARCHAR(20)=NULL,
@IMAGE_NAME VARCHAR(100)=NULL,
@USER_IMAGE IMAGE=NULL
)
AS
BEGIN
   IF(@MODE = 'INSERT')
   BEGIN
    INSERT into UserDetail(FIRST_NAME,LAST_NAME,USER_NAME,USER_PASSWORD,USER_TYPE,LOGIN_DATE,IMAGE_NAME,USER_IMAGE) values(@FIRST_NAME,@LAST_NAME,@USER_NAME,@USER_PASSWORD,@USER_TYPE,SYSDATETIME(),@IMAGE_NAME,@USER_IMAGE);
   END
   ELSE IF(@MODE = 'UPDATE')
   BEGIN
   UPDATE UserDetail SET FIRST_NAME=@FIRST_NAME,LAST_NAME=@LAST_NAME
   ,USER_NAME=@USER_NAME,USER_PASSWORD=@USER_PASSWORD,USER_TYPE=@USER_TYPE
   ,LOGIN_DATE=SYSDATETIME()
    WHERE UserId=@UserId;
   END
   ELSE IF(@MODE = 'DELETE')
   BEGIN
   DELETE FROM UserDetail WHERE UserId=@UserId;
   END
   ELSE IF(@MODE = 'ADMIN_SELECT')
   BEGIN
   SELECT * FROM UserDetail;
   END
   ELSE IF(@MODE = 'MANGER_SELECT')
   BEGIN
	select * from UserDetail where USER_TYPE in(2,3);
   END
   ELSE IF(@MODE = 'USERS_SELECT')
   BEGIN
	select * from UserDetail where USER_TYPE in(3);
   END
   ELSE IF(@MODE = 'USERS_LOG_INSERT')
   BEGIN
	 INSERT into USER_LOG(USER_NAME,LOGIN_DATE,UserId) values(@USER_NAME,SYSDATETIME(),@UserId);
   END
    ELSE IF(@MODE = 'USERS_LOGIN_SELECT')
   BEGIN
	select COUNT(*)CNT,(case when USER_TYPE=1 then 'Admin' when USER_TYPE=2 then 'Manager' else 'Users' end)USER_TYPE,UserId from UserDetail
	where USER_NAME= @USER_NAME AND USER_PASSWORD=@USER_PASSWORD
	group by USER_TYPE,UserId;
   END
    ELSE IF(@MODE = 'MANGER_REPORTS')
   BEGIN
	SELECT  FIRST_NAME,LAST_NAME,LAST_LOGIN_DATE,USER_CNT
	,IMAGE_NAME,USER_IMAGE
	FROM(
			SELECT UD.FIRST_NAME,UD.LAST_NAME,convert(varchar, UL.LOGIN_DATE, 107) LAST_LOGIN_DATE
			,UD.USERID
			,ud.USER_TYPE
			,ud.IMAGE_NAME
			,ud.USER_IMAGE
			FROM USERDETAIL UD LEFT JOIN USER_LOG UL
			ON UL.USERID=UD.USERID
		) AS TB1
	INNER JOIN
	(
	  SELECT USERID ,COUNT(*)USER_CNT FROM USER_LOG
	  GROUP BY USERID
	)
	AS TB2 ON TB2.USERID=TB1.USERID
	where TB1.USER_TYPE <>1
   END
   ELSE IF(@MODE = 'ADMIN_REPORTS')
   BEGIN
	SELECT distinct FIRST_NAME [First Name],LAST_NAME [Last Name],LAST_LOGIN_DATE [Last Login Date],USER_CNT [Login Count]

	FROM(
			SELECT UD.FIRST_NAME ,UD.LAST_NAME ,convert(varchar, UL.LOGIN_DATE, 107) LAST_LOGIN_DATE
			,UD.USERID
			,ud.USER_TYPE
			FROM USERDETAIL UD LEFT JOIN USER_LOG UL
			ON UL.USERID=UD.USERID
		) AS TB1
	INNER JOIN
	(
	  SELECT USERID ,COUNT(*)USER_CNT FROM USER_LOG
	  GROUP BY USERID
	)
	AS TB2 ON TB2.USERID=TB1.USERID
   END
     ELSE IF(@MODE = 'USER_PROFILE')
   BEGIN
	select UserId,FIRST_NAME,LAST_NAME,USER_NAME,USER_PASSWORD
	,(case when USER_TYPE=1 then 'Admin' when USER_TYPE=2 then 'Manager' else 'Users' end)USER_TYPE
	from UserDetail WHERE UserId=@UserId;
   END
END